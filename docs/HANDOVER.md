# Remote Antigravity 引継ぎ資料

## プロジェクト概要
**Remote Antigravity** は、外出先から自宅のPC環境を監視・操作するためのリモートブリッジシステムです。Google Gemini API を活用し、自然言語での対話を通じてPCの操作や画面確認を行います。

## システム構成
本システムは以下のコンポーネントで構成されています。

1.  **Bridge Server (`bridge-server`)**
    *   **技術スタック**: Node.js, Express, Socket.IO, chokidar
    *   **役割**:
        *   `mobile-chat.md` ファイルを監視し、AIエージェントの応答を読み取る。
        *   Socket.IO 経由でモバイルクライアントと双方向通信を行う。
        *   「スクショ」コマンドを検知し、PC画面をキャプチャしてBase64画像として送信する。
    *   **ポート**: 3001

2.  **Mobile Client (`mobile-client`)**
    *   **技術スタック**: Next.js (React), Tailwind CSS, Socket.IO Client
    *   **役割**:
        *   ユーザーインターフェース提供。
        *   チャット形式でのコマンド送信とAI応答の表示。
        *   画像のレンダリング。
    *   **ポート**: 3000

3.  **Communication Core**
    *   **`mobile-chat.md`**: システムとAIエージェント間の対話履歴を保持するMarkdownファイル。`runner.ts` がこのファイルを読み書きしてAI処理を行います。

## 直近の実装・修正内容 (スクリーンショット機能)

### 1. スクリーンショット送信の不具合修正
*   **問題**: モバイルから「スクショ」と送っても、画像が表示されない、または古いメッセージが表示される。
*   **原因**:
    *   `mobile-chat.md` ファイルに改行が少なく、行ベースの読み込み処理で全体が1行として扱われてしまい、正規表現パースが失敗していた。
    *   Socket.IO で画像データ（Base64）は送信されていたが、Reactクライアント側でレンダリングされていなかった。
*   **対応**:
    *   **Bridge Server (`socket.ts`)**: ファイル読み込みロジックを行ベースから**位置ベース (`lastIndexOf` 等)** に変更。最後の `[Agent]` タグを確実に特定し、Base64データを含むメッセージ全体を正しく抽出するように修正。
    *   **Mobile Client (`MessageList.tsx`)**: `ReactMarkdown` がセキュリティ上の理由で `data:` スキームの画像をサニタイズ（削除）していた問題を回避するため、**正規表現で画像タグを手動抽出し、Markdownとは別にレンダリング**するロジックを実装。

### 2. 接続設定の修正
*   **問題**: `mobile-client` がデフォルトで外部のデモサーバーに接続しようとしていた。
*   **対応**: `mobile-client/.env.local` を作成し、接続先をローカルサーバー (`http://localhost:3001`) に明示的に指定。

## 起動・操作方法

### 起動
プロジェクトルートで以下のスクリプトを実行します（管理者権限推奨）。

```powershell
.\scripts\start-remote.ps1
```

これにより、Bridge Server (Port 3001) と Mobile Client (Port 3000)、およびトンネリング (Cloudflared) が起動します。

### スクリーンショット機能のテスト
1.  モバイルクライアント (`localhost:3000` またはトンネルURL) にアクセス。
2.  チャットで「スクショ」または「画面」と送信。
3.  システムがPC画面をキャプチャし、チャット画面に画像が表示されます。

## 今後の課題・TODO
*   **`useAgentSocket.ts` のデバッグログ**: 開発用に詳細なログ出力を残しています。本番運用時には整理を検討してください。
*   **画像圧縮**: 現在JPEG形式でBase64エンコードしていますが、転送量削減のために圧縮率の調整やWebP化を検討する余地があります。
