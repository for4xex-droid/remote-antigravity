# Remote Antigravity 引継ぎ資料

## プロジェクト概要
**Remote Antigravity** は、外出先から自宅のPC環境を監視・操作するためのリモートブリッジシステムです。Google Gemini API を活用し、自然言語での対話を通じてPCの操作や画面確認を行います。

## システム構成
本システムは以下のコンポーネントで構成されています。

1.  **Bridge Server (`bridge-server`)**
    *   **技術スタック**: Node.js, Express, Socket.IO, chokidar
    *   **役割**:
        *   `mobile-chat.md` ファイルを監視し、AIエージェントの応答を読み取る。
        *   Socket.IO 経由でモバイルクライアントと双方向通信を行う。
        *   「スクショ」コマンドを検知し、PC画面をキャプチャしてBase64画像として送信する。
    *   **ポート**: 3001

2.  **Mobile Client (`mobile-client`)**
    *   **技術スタック**: Next.js (React), Tailwind CSS, Socket.IO Client
    *   **役割**:
        *   ユーザーインターフェース提供。
        *   チャット形式でのコマンド送信とAI応答の表示。
        *   画像のレンダリング。
    *   **ポート**: 3000

3.  **Communication Core**
    *   **`mobile-chat.md`**: システムとAIエージェント間の対話履歴を保持するMarkdownファイル。`runner.ts` がこのファイルを読み書きしてAI処理を行います。

## 直近の実装・修正内容 (スクリーンショット機能)

### 1. スクリーンショット送信の不具合修正
*   **問題**: モバイルから「スクショ」と送っても、画像が表示されない、または古いメッセージが表示される。
*   **原因**:
    *   `mobile-chat.md` ファイルに改行が少なく、行ベースの読み込み処理で全体が1行として扱われてしまい、正規表現パースが失敗していた。
    *   Socket.IO で画像データ（Base64）は送信されていたが、Reactクライアント側でレンダリングされていなかった。
*   **対応**:
    *   **Bridge Server (`socket.ts`)**: ファイル読み込みロジックを行ベースから**位置ベース (`lastIndexOf` 等)** に変更。最後の `[Agent]` タグを確実に特定し、Base64データを含むメッセージ全体を正しく抽出するように修正。
    *   **Mobile Client (`MessageList.tsx`)**: `ReactMarkdown` がセキュリティ上の理由で `data:` スキームの画像をサニタイズ（削除）していた問題を回避するため、**正規表現で画像タグを手動抽出し、Markdownとは別にレンダリング**するロジックを実装。

### 2. 接続設定の修正
*   **問題**: `mobile-client` がデフォルトで外部のデモサーバーに接続しようとしていた。
*   **対応**: `mobile-client/.env.local` を作成し、接続先をローカルサーバー (`http://localhost:3001`) に明示的に指定。

### 3. 機能拡張: 「神の手」と「神の声」
*   **コマンド実行 (`/run`)**:
    *   `/run <command>` でサーバー上のコマンドを実行可能。
    *   `cd` コマンドでディレクトリ移動の状態を維持。
    *   Windows 文字化け対策済み。
*   **音声操作 (Voice Control)**:
    *   モバイルクライアントのマイクボタンで録音・送信。
    *   サーバー側でGemini 2.0 Flash Expを使用して文字起こし。
    *   「ラン エルエス」→ `/run dir` のように、日本語音声をシステムコマンドに自動変換。

## 起動・操作方法

### 起動
プロジェクトルートで以下のスクリプトを実行します（管理者権限推奨）。

```powershell
.\scripts\start-remote.ps1
```

これにより、Bridge Server (Port 3001) と Mobile Client (Port 3000)、およびトンネリング (Cloudflared) が起動します。

### 操作ガイド

#### 1. スクリーンショット
*   チャットで「スクショ」「画面」と送信。

#### 2. コマンド実行 (God Mode)
*   テキストで送信: `/run dir`, `/run ipconfig` など。
*   `/run cd ..` でディレクトリ移動も可能。

#### 3. 音声入力 (God Voice)
*   入力欄のマイクボタンを押して録音。
*   例: 「ラン エルエス」と話すと、ファイル一覧が表示されます。
*   例: 「こんにちは」と話すと、AIと会話できます。

#### 4. 安全装置 (Safety Lock)
*   `del`, `rm`, `format`, `shutdown` などの危険なコマンドが含まれる場合、システムは自動的に実行を一時停止し、ユーザーに確認を求めます。
*   チャットで `y` または `はい` と返信すると実行され、それ以外の場合はキャンセルされます。

## 今後の課題・TODO
*   **`useAgentSocket.ts` のデバッグログ**: 開発用に詳細なログ出力を残しています。本番運用時には整理を検討してください。
*   **画像圧縮**: 現在JPEG形式でBase64エンコードしていますが、転送量削減のために圧縮率の調整やWebP化を検討する余地があります。
